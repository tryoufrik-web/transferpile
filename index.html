<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üì¶ Kirim File ‚Ä¢ Peer to Peer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #0a0c10; color: #e2e8f0; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 16px; }
        .container { max-width: 700px; width: 100%; background: #14181f; border-radius: 32px; padding: 28px; border: 1px solid #2d3a4a; box-shadow: 0 12px 30px rgba(0,0,0,0.5); }
        h1 { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #91c7ff, #6d9eff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 4px; }
        .sub { color: #a0b3cc; margin-bottom: 24px; font-size: 0.95rem; }

        .connection-area { background: #1e2630; border-radius: 24px; padding: 20px; margin-bottom: 24px; border: 1px solid #2f3b4b; }
        .flex-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .peer-id-box { background: #0b0e12; border-radius: 40px; padding: 10px 18px; display: flex; align-items: center; gap: 10px; flex: 1; border: 1px solid #3a4a5a; }
        .peer-id-box input { background: transparent; border: none; color: #b5e4ff; font-family: monospace; font-size: 1rem; flex: 1; outline: none; }
        .badge { background: #2e3b4b; border-radius: 30px; padding: 6px 14px; font-size: 0.8rem; color: #d1e0f0; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; transition: 0.2s; }
        .badge:hover { background: #3e5062; }
        .qr-container { background: white; border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 16px; margin-top: 16px; border: 2px solid #cbd5e0; }
        #qrImage { width: 100px; height: 100px; background: white; border-radius: 12px; object-fit: contain; }

        .status-bar { background: #1b222c; border-radius: 40px; padding: 12px 20px; display: flex; align-items: center; gap: 12px; margin: 16px 0; border: 1px solid #3b4a5a; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #f43f5e; transition: 0.2s; }
        .dot.connected { background: #2ed573; box-shadow: 0 0 10px #2ed573; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }

        .upload-card { background: #1e2630; border-radius: 24px; padding: 20px; margin-bottom: 20px; border: 1px solid #2f3b4b; }
        .upload-zone { border: 2px dashed #4f6f8f; border-radius: 20px; padding: 30px 16px; text-align: center; cursor: pointer; background: #10161c; transition: 0.2s; }
        .upload-zone:hover { border-color: #6d9eff; background: #19232b; }
        .upload-zone i { font-size: 2.5rem; color: #6d9eff; margin-bottom: 8px; }

        .btn { background: #6d9eff; color: #0b0e12; border: none; padding: 14px 24px; border-radius: 40px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; transition: 0.2s; }
        .btn:disabled { background: #3a4a5a; opacity: 0.5; pointer-events: none; }
        .btn-outline { background: transparent; border: 1.5px solid #4f6f8f; color: #e2e8f0; }

        .file-list { margin-top: 16px; max-height: 250px; overflow-y: auto; padding-right: 4px; }
        .file-item { background: #1a212c; border-radius: 16px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #6d9eff; }
        .file-info { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
        .file-icon { font-size: 1.6rem; }
        .file-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 0.75rem; color: #9aaec2; }

        .logs { background: #0e1319; border-radius: 20px; padding: 16px; margin-top: 24px; border: 1px solid #2d3a4a; font-family: monospace; font-size: 0.8rem; max-height: 150px; overflow-y: auto; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #25303a; color: #b0c8dd; display: flex; gap: 12px; }
        .log-time { color: #7aa2f7; }

        .footer { display: flex; justify-content: space-between; margin-top: 16px; color: #859db0; font-size: 0.75rem; }
        .flex { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .mt-2 { margin-top: 16px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìÅ webfolder ¬∑ p2p</h1>
        <div class="sub">Kirim file langsung ‚Ä¢ QR / ID ‚Ä¢ dua arah</div>

        <!-- PEER ID & QR -->
        <div class="connection-area">
            <div class="flex-row">
                <span style="color:#a5c9ff;"><i class="fas fa-id-card"></i> ID peer kamu:</span>
                <div class="peer-id-box">
                    <input type="text" id="peerIdInput" readonly value="menyiapkan...">
                    <button class="badge" onclick="copyPeerId()"><i class="fas fa-copy"></i> Copy</button>
                </div>
            </div>
            <div class="qr-container">
                <img id="qrImage" src="" alt="QR Code">
                <div style="flex:1;">
                    <div style="font-weight: 600; color:#0b0e14;">üî≥ Scan QR untuk konek</div>
                    <div style="font-size:0.85rem; color:#2d3a4a; margin:8px 0;">Atau masukkan ID peer lain di bawah</div>
                    <button class="badge" onclick="generateQR()" style="background:#6d9eff; color:white;"><i class="fas fa-sync-alt"></i> Buat QR ulang</button>
                </div>
            </div>
        </div>

        <!-- STATUS & SAMBUNGAN -->
        <div class="status-bar">
            <span class="dot" id="connectionDot"></span>
            <span id="connectionStatus">Memulai peer...</span>
            <span style="margin-left:auto; display:flex; gap:6px;">
                <button class="badge" onclick="resetConnection()" style="background:#475569;"><i class="fas fa-power-off"></i> Reset peer</button>
            </span>
        </div>

        <div style="background:#1b222c; border-radius: 40px; padding: 16px 20px; margin-bottom: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <i class="fas fa-plug" style="color:#6d9eff;"></i>
            <span style="font-weight:500;">Sambung ke device lain:</span>
            <input type="text" id="targetPeerId" placeholder="masukkan ID peer tujuan" style="flex:2; min-width:180px; background:#0e1319; border:1px solid #3f4e60; border-radius: 40px; padding: 10px 18px; color:white; outline:none;">
            <button class="badge" onclick="connectToPeer()" style="background:#6d9eff; color:white; padding:10px 24px; border-radius:40px;"><i class="fas fa-link"></i> Sambung</button>
        </div>

        <!-- ===== UPLOAD & KIRIM ===== -->
        <div class="upload-card">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
                <i class="fas fa-upload" style="color:#6d9eff; font-size:1.4rem;"></i>
                <h3 style="font-weight:600;">Kirim File</h3>
                <span style="margin-left:auto; font-size:0.8rem; color:#9aaec2;" id="peerTargetDisplay">(belum terhubung)</span>
            </div>
            <!-- Drop zone -->
            <div class="upload-zone" id="dropZone">
                <input type="file" id="fileInput" multiple style="display:none;">
                <i class="fas fa-cloud-upload-alt"></i>
                <h4>Tarik file atau klik di sini</h4>
                <p style="color:#9aaec2; font-size:0.85rem;">file manager akan terbuka</p>
            </div>
            <!-- Daftar file yang dipilih -->
            <div id="fileListContainer"></div>
            <!-- Tombol kirim -->
            <div style="display:flex; gap:12px; margin-top:16px;">
                <button class="btn" id="sendBtn" disabled onclick="sendFiles()"><i class="fas fa-paper-plane"></i> Kirim Sekarang</button>
                <button class="btn-outline" onclick="clearSelectedFiles()" style="width:auto; padding:14px 20px;"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>

        <!-- ===== FILE DITERIMA ===== -->
        <div class="upload-card">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
                <i class="fas fa-inbox" style="color:#2ed573; font-size:1.4rem;"></i>
                <h3 style="font-weight:600;">File Diterima</h3>
                <span style="margin-left:auto;" class="badge" id="incomingCountBadge">0 file</span>
            </div>
            <div id="receivedFileListContainer">
                <div style="text-align:center; padding:32px 16px; color:#73879b;">
                    <i class="fas fa-download" style="font-size:2.2rem; margin-bottom:12px; opacity:0.6;"></i>
                    <p>Belum ada file diterima</p>
                </div>
            </div>
            <button class="btn-outline" id="downloadAllBtn" disabled onclick="downloadAllFiles()" style="margin-top:12px;"><i class="fas fa-file-export"></i> Download semua</button>
        </div>

        <!-- LOG -->
        <div class="logs">
            <div style="display:flex; gap:8px; margin-bottom:8px; color:#a5c9ff;"><i class="fas fa-list"></i> Aktivitas</div>
            <div id="logStream"></div>
        </div>
        <div class="footer">
            <span><i class="fas fa-shield-alt"></i> P2P langsung</span>
            <span><i class="fas fa-qrcode"></i> QR = ID peer</span>
        </div>
    </div>

    <script>
        // ========== KONFIGURASI PEER ==========
        const ICE_CONFIG = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        };

        // ========== STATE ==========
        let peer = null;
        let currentConn = null;
        let isConnected = false;
        let connectedPeerId = '';
        let currentPeerId = '';
        let selectedFiles = [];
        let receivedFiles = [];

        // DOM
        const peerIdInput = document.getElementById('peerIdInput');
        const qrImage = document.getElementById('qrImage');
        const connectionDot = document.getElementById('connectionDot');
        const connectionStatus = document.getElementById('connectionStatus');
        const targetPeerIdInput = document.getElementById('targetPeerId');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const sendBtn = document.getElementById('sendBtn');
        const receivedContainer = document.getElementById('receivedFileListContainer');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const incomingCountBadge = document.getElementById('incomingCountBadge');
        const logStream = document.getElementById('logStream');
        const peerTargetDisplay = document.getElementById('peerTargetDisplay');

        // ========== GENERATE ID ==========
        function generatePeerId() {
            return 'wf-' + Math.random().toString(36).substring(2, 10);
        }

        // ========== INIT PEER ==========
        function initPeer() {
            const requestedId = generatePeerId();
            currentPeerId = requestedId;
            peerIdInput.value = requestedId;
            connectionStatus.innerText = 'Menyiapkan peer...';
            connectionDot.classList.remove('connected');

            generateQRFromId(requestedId);
            addLog(`üîÑ Memulai peer dengan ID: ${requestedId}`);

            if (peer) peer.destroy();
            peer = new Peer(requestedId, {
                host: 'peerjs.com',
                port: 443,
                secure: true,
                config: ICE_CONFIG
            });

            peer.on('open', (id) => {
                currentPeerId = id;
                peerIdInput.value = id;
                connectionStatus.innerText = `Siap, ID: ${id}`;
                connectionDot.classList.add('connected');
                addLog(`‚úÖ Peer siap, ID: ${id}`);
                if (id !== requestedId) generateQRFromId(id);
            });

            peer.on('connection', (conn) => {
                currentConn = conn;
                connectedPeerId = conn.peer;
                isConnected = true;
                connectionStatus.innerText = `Terhubung dengan ${conn.peer}`;
                peerTargetDisplay.innerText = `(terhubung ke ${conn.peer})`;
                addLog(`üîó Koneksi masuk dari ${conn.peer}`);
                setupConnection(conn);
            });

            peer.on('error', (err) => {
                console.error(err);
                addLog(`‚ùå Peer error: ${err.type || err}`);
                if (err.type === 'unavailable-id') {
                    const newId = generatePeerId();
                    currentPeerId = newId;
                    peerIdInput.value = newId;
                    generateQRFromId(newId);
                    connectionStatus.innerText = `ID dipakai, ganti: ${newId}`;
                    peer.reconnect();
                }
            });
        }

        // ========== SETUP KONEKSI ==========
        function setupConnection(conn) {
            conn.on('open', () => {
                isConnected = true;
                connectedPeerId = conn.peer;
                connectionStatus.innerText = `Terhubung dengan ${conn.peer}`;
                peerTargetDisplay.innerText = `(terhubung ke ${conn.peer})`;
                addLog(`‚úÖ Koneksi terbuka dengan ${conn.peer}`);
            });

            conn.on('data', (data) => {
                if (data?.type === 'file') {
                    try {
                        const file = new File([data.buffer], data.name, { type: data.type });
                        receivedFiles.push({ file, name: data.name, size: data.size, type: data.type });
                        renderReceivedFiles();
                        addLog(`üì• Diterima: ${data.name} (${formatBytes(data.size)})`);
                    } catch (e) {
                        addLog(`‚ùå Gagal menerima file: ${e.message}`);
                    }
                }
            });

            conn.on('close', () => {
                isConnected = false;
                connectedPeerId = '';
                connectionStatus.innerText = 'Koneksi terputus';
                peerTargetDisplay.innerText = '(tidak terhubung)';
                connectionDot.classList.remove('connected');
                addLog('‚ö†Ô∏è Koneksi ditutup');
                currentConn = null;
            });
        }

        // ========== CONNECT KE PEER LAIN ==========
        window.connectToPeer = function() {
            const targetId = targetPeerIdInput.value.trim();
            if (!targetId) { alert('Masukkan ID peer tujuan'); return; }
            if (targetId === currentPeerId) { alert('Tidak bisa sambung ke diri sendiri'); return; }

            connectionStatus.innerText = `Menyambung ke ${targetId}...`;
            const conn = peer.connect(targetId, { reliable: true, serialization: 'json' });
            currentConn = conn;
            connectedPeerId = targetId;
            setupConnection(conn);
        };

        // ========== QR CODE ==========
        function generateQRFromId(id) {
            if (!id) return;
            const url = window.location.origin + window.location.pathname + '?connect=' + encodeURIComponent(id);
            const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&margin=1&data=${encodeURIComponent(url)}&t=${Date.now()}`;
            qrImage.src = qrApi;
        }
        window.generateQR = function() { if (currentPeerId) generateQRFromId(currentPeerId); };

        // ========== KIRIM FILE ==========
        window.sendFiles = function() {
            if (!currentConn || !isConnected) { alert('Belum terhubung ke device lain!'); return; }
            if (selectedFiles.length === 0) { alert('Pilih file dulu!'); return; }

            addLog(`üì§ Mengirim ${selectedFiles.length} file ke ${connectedPeerId}...`);

            selectedFiles.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentConn.send({
                        type: 'file',
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        buffer: e.target.result
                    });
                    addLog(`‚úÖ Terkirim: ${file.name}`);
                };
                reader.readAsArrayBuffer(file);
            });

            // TIDAK OTOMATIS HAPUS, biar user hapus manual
            // Hanya kasih notifikasi
            addLog('üéâ Pengiriman selesai. Hapus file dari daftar jika sudah tidak diperlukan.');
        };

        // ========== HANDLE UPLOAD (FILE MANAGER WAJIB MUNCUL) ==========
        function handleFiles(files) {
            if (!files || files.length === 0) return;
            const arr = Array.from(files);
            // Filter duplikat (nama & size sama)
            const newFiles = arr.filter(f => 
                !selectedFiles.some(ex => ex.name === f.name && ex.size === f.size)
            );
            if (newFiles.length === 0) {
                addLog('‚ö†Ô∏è File sudah ada di daftar');
                return;
            }
            selectedFiles = [...selectedFiles, ...newFiles];
            renderFileList();
            addLog(`üìÅ +${newFiles.length} file (${formatBytes(newFiles.reduce((a,b)=>a+b.size,0))})`);
        }

        function renderFileList() {
            if (selectedFiles.length === 0) {
                fileListContainer.innerHTML = `<div style="color:#73879b; padding:16px; text-align:center;">Belum ada file dipilih</div>`;
                sendBtn.disabled = true;
                return;
            }
            sendBtn.disabled = false;
            let html = `<div class="file-list">`;
            selectedFiles.forEach((f, i) => {
                html += `<div class="file-item">
                    <div class="file-info">
                        <span class="file-icon">${getIcon(f.type)}</span>
                        <div style="flex:1; min-width:0;">
                            <div class="file-name">${escapeHTML(f.name)}</div>
                            <div class="file-meta">${formatBytes(f.size)}</div>
                        </div>
                    </div>
                    <i class="fas fa-times" style="color:#ff8a8a; cursor:pointer; padding:8px;" onclick="removeFile(${i})"></i>
                </div>`;
            });
            html += `</div>`;
            fileListContainer.innerHTML = html;
        }

        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            renderFileList();
            addLog('üóëÔ∏è File dihapus dari daftar kirim');
        };

        window.clearSelectedFiles = function() {
            selectedFiles = [];
            renderFileList();
            addLog('üßπ Semua file dihapus dari daftar kirim');
        };

        // ========== RENDER FILE DITERIMA ==========
        function renderReceivedFiles() {
            if (receivedFiles.length === 0) {
                receivedContainer.innerHTML = `<div style="text-align:center; padding:32px 16px; color:#73879b;">
                    <i class="fas fa-download" style="font-size:2.2rem; opacity:0.6;"></i>
                    <p>Belum ada file diterima</p>
                </div>`;
                downloadAllBtn.disabled = true;
                incomingCountBadge.innerText = '0 file';
                return;
            }
            downloadAllBtn.disabled = false;
            incomingCountBadge.innerText = receivedFiles.length + ' file';
            let html = `<div class="file-list">`;
            receivedFiles.forEach((f, i) => {
                html += `<div class="file-item" style="border-left-color:#2ed573;">
                    <div class="file-info">
                        <span class="file-icon">${getIcon(f.type)}</span>
                        <div style="flex:1;">
                            <div class="file-name">${escapeHTML(f.name)}</div>
                            <div class="file-meta">${formatBytes(f.size)}</div>
                        </div>
                    </div>
                    <i class="fas fa-download" style="color:#6d9eff; cursor:pointer; padding:8px;" onclick="downloadFile(${i})"></i>
                </div>`;
            });
            html += `</div>`;
            receivedContainer.innerHTML = html;
        }

        window.downloadFile = function(index) {
            const file = receivedFiles[index].file;
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(url);
            addLog(`‚¨áÔ∏è Download: ${file.name}`);
        };

        window.downloadAllFiles = function() {
            receivedFiles.forEach((_, i) => setTimeout(() => downloadFile(i), i * 200));
            addLog(`üì• Download ${receivedFiles.length} file`);
        };

        // ========== RESET ==========
        window.resetConnection = function() {
            if (peer) peer.destroy();
            peer = null;
            currentConn = null;
            isConnected = false;
            connectedPeerId = '';
            connectionStatus.innerText = 'Peer di-reset';
            connectionDot.classList.remove('connected');
            peerTargetDisplay.innerText = '(reset)';
            initPeer();
        };

        window.copyPeerId = function() {
            navigator.clipboard.writeText(currentPeerId);
            addLog('üìã ID peer dicopy');
        };

        // ========== AUTO CONNECT DARI URL ==========
        function checkUrlForAutoConnect() {
            const params = new URLSearchParams(window.location.search);
            const target = params.get('connect');
            if (target) {
                targetPeerIdInput.value = target;
                addLog(`üîç Auto-connect ke ${target}`);
                setTimeout(() => connectToPeer(), 600);
            }
        }

        // ========== UTILS ==========
        function getIcon(type) {
            if (type.includes('image')) return 'üñºÔ∏è';
            if (type.includes('video')) return 'üé¨';
            if (type.includes('audio')) return 'üéµ';
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('zip')||type.includes('rar')) return 'üì¶';
            if (type.includes('text')) return 'üìù';
            return 'üìÅ';
        }

        function formatBytes(b) {
            if (b===0) return '0 B';
            const u = ['B','KB','MB','GB'];
            const i = Math.floor(Math.log(b)/Math.log(1024));
            return (b/Math.pow(1024,i)).toFixed(1)+' '+u[i];
        }

        function escapeHTML(s) {
            return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        }

        function addLog(msg) {
            const e = document.createElement('div');
            e.className = 'log-entry';
            e.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})}]</span> ${msg}`;
            logStream.appendChild(e);
            logStream.scrollTop = logStream.scrollHeight;
            if (logStream.children.length > 15) logStream.removeChild(logStream.children[0]);
        }

        // ========== SETUP UPLOAD - PASTI BUKA FILE MANAGER ==========
        function setupUpload() {
            // Klik di area upload -> panggil fileInput.click()
            dropZone.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();  // INI YANG BUKA FILE MANAGER
            });

            // Drag & drop
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.style.borderColor = '#6d9eff';
                dropZone.style.background = '#19232b';
            });
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.style.borderColor = '#4f6f8f';
                dropZone.style.background = '#10161c';
            });
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.style.borderColor = '#4f6f8f';
                dropZone.style.background = '#10161c';
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });

            // Input file change
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFiles(e.target.files);
                    // Reset input agar bisa pilih file yang sama lagi
                    fileInput.value = '';
                }
            });
        }

        // ========== INIT ==========
        window.onload = function() {
            initPeer();
            setupUpload();
            checkUrlForAutoConnect();
            renderFileList();
            renderReceivedFiles();
            addLog('üöÄ Siap. Klik area upload untuk pilih file (file manager akan terbuka).');
        };
    </script>
</body>
</html>
