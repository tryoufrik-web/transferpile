<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ WebFolder ‚Ä¢ Peer Transfer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #0b0e14; color: #edf2f7; display: flex; align-items: center; justify-content: center; padding: 24px; }
        .container { max-width: 1100px; width: 100%; }
        .hero { text-align: center; margin-bottom: 48px; }
        .hero h1 { font-size: 3.2rem; background: linear-gradient(135deg, #a0e7ff, #7aa2f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 28px; }
        @media (max-width:720px){ .grid { grid-template-columns: 1fr; } }
        .card { background: #14181f; border-radius: 32px; padding: 28px; border: 1px solid #2a2f37; }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #2d3748; }
        .card-header i { font-size: 1.8rem; color: #7aa2f7; }
        .folder-section { background: #0f131a; border-radius: 20px; padding: 20px; margin-bottom: 28px; border: 1px dashed #4a5568; }
        .link-box { background: #0a0d12; border-radius: 14px; padding: 16px; display: flex; align-items: center; gap: 12px; border: 1px solid #2d3748; margin-bottom: 16px; }
        .link-box input { flex:1; background:transparent; border:none; color:#a0e7ff; font-family:monospace; font-size:0.95rem; padding:4px 0; outline:none; }
        .qr-container { background: white; border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 20px; margin-top: 16px; border: 2px solid #e2e8f0; }
        #qrImage { width: 120px; height: 120px; background: white; border-radius: 12px; object-fit: contain; }
        .qr-info { flex:1; } .qr-info h4 { color: #0b0e14; } .qr-info p { color: #2d3748; }
        .badge { background: #2d3748; border-radius: 30px; padding: 6px 14px; font-size: 0.8rem; color: #cbd5e0; display: inline-flex; align-items: center; gap: 6px; }
        .peer-status { background: #1a1e2a; border-radius: 40px; padding: 12px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; border: 1px solid #4a5568; }
        .peer-dot { width: 14px; height: 14px; border-radius: 50%; background: #ff4757; transition: 0.2s; }
        .peer-dot.connected { background: #2ed573; box-shadow: 0 0 12px #2ed573; animation: pulse 1.5s infinite; }
        .peer-dot.warning { background: #ffa502; box-shadow: 0 0 12px #ffa502; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
        .upload-zone { border: 2px dashed #4a5568; border-radius: 20px; padding: 36px 20px; text-align: center; cursor: pointer; background: #0f131a; margin-bottom: 20px; }
        .upload-zone:hover { border-color: #7aa2f7; background: rgba(122,162,247,0.05); }
        .upload-zone i { font-size: 2.8rem; color: #7aa2f7; }
        .file-list { margin-top: 16px; max-height: 300px; overflow-y: auto; }
        .file-item { background: #1a1e26; border-radius: 16px; padding: 16px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #7aa2f7; }
        .file-info { display: flex; align-items: center; gap: 16px; flex:1; }
        .btn { background: #7aa2f7; color: #0b0e14; border: none; padding: 14px 24px; border-radius: 40px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap:8px; width:100%; }
        .btn-outline { background: transparent; border: 1.5px solid #4a5568; color: #e2e8f0; }
        .btn-outline:hover { background: #1e242c; border-color: #7aa2f7; }
        .btn:disabled { opacity: 0.5; pointer-events: none; }
        .incoming-area { background: #0f131a; border-radius: 20px; padding: 20px; margin-top: 20px; }
        .empty-inbox { text-align: center; padding: 40px 20px; color: #718096; }
        .logs-panel { background: #0a0d12; border-radius: 20px; padding: 20px; margin-top: 20px; border: 1px solid #2d3748; }
        .log-stream { font-family: monospace; font-size: 0.85rem; color: #a0aec0; max-height: 150px; overflow-y: auto; }
        .log-entry { padding: 6px 0; border-bottom: 1px solid #1e242c; display: flex; gap: 12px; }
        .log-time { color: #7aa2f7; }
        .footer-info { display: flex; justify-content: space-between; padding: 20px 0 0; color: #718096; border-top: 1px solid #2d3748; margin-top: 20px; }
        .flex { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .mt-2 { margin-top: 12px; }
        .retry-btn { background: #ffa502; border: none; color: black; padding: 6px 12px; border-radius: 30px; font-size: 0.8rem; cursor: pointer; }
        .retry-btn:hover { background: #ffb142; }
        .server-select { background: #0a0d12; border: 1px solid #4a5568; color: white; padding: 8px 12px; border-radius: 30px; font-size: 0.8rem; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="hero"><h1>üìÅ webfolder ¬∑ peer</h1><p>Multi-server ‚Ä¢ TURN fallback ‚Ä¢ Koneksi stabil</p></div>
        <div class="grid">
            <!-- SENDER (LAPTOP) -->
            <div class="card">
                <div class="card-header"><i class="fas fa-laptop"></i><h2>Device Saya (Pengirim)</h2></div>
                <div class="peer-status">
                    <span class="peer-dot" id="peerDot"></span>
                    <span id="peerStatus">Menyiapkan peer...</span>
                </div>
                <div class="folder-section">
                    <div class="folder-label"><i class="fas fa-id-card"></i> ID Peer (bagikan ke penerima)</div>
                    <div class="link-box">
                        <i class="fas fa-lock" style="color:#a0e7ff;"></i>
                        <input type="text" id="peerIdInput" value="-" readonly>
                        <button class="badge" onclick="copyPeerId()"><i class="fas fa-copy"></i> Copy</button>
                    </div>
                    <!-- QR CODE -->
                    <div class="qr-container">
                        <img id="qrImage" src="" alt="QR Code">
                        <div class="qr-info">
                            <h4><i class="fas fa-qrcode"></i> QR Koneksi</h4>
                            <p>Scan dengan HP untuk terima file</p>
                            <button class="badge" onclick="generateQR()" style="background:#7aa2f7; color:white;"><i class="fas fa-sync-alt"></i> Buat QR</button>
                        </div>
                    </div>
                    <div class="flex mt-2">
                        <span class="badge">Server:</span>
                        <select id="serverSelect" class="server-select" onchange="switchServer()">
                            <option value="peerjs.com">peerjs.com (default)</option>
                            <option value="0.peerjs.com">0.peerjs.com</option>
                            <option value="peerjs.xyz">peerjs.xyz (mirror)</option>
                        </select>
                    </div>
                </div>
                <!-- UPLOAD -->
                <div class="upload-zone" id="dropZoneSender">
                    <input type="file" id="fileInputSender" multiple style="display:none;">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Klik untuk pilih file</h3>
                    <p>atau drag & drop</p>
                </div>
                <div id="senderFileListContainer"></div>
                <div style="display:flex; gap:12px; margin-top:8px;">
                    <button class="btn" id="sendBtn" disabled onclick="sendFiles()"><i class="fas fa-paper-plane"></i> Kirim File</button>
                    <button class="btn-outline" onclick="clearSenderFiles()"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
            <!-- RECEIVER (HP) -->
            <div class="card">
                <div class="card-header"><i class="fas fa-mobile-alt"></i><h2>Device Lain (Penerima)</h2></div>
                <div style="background:#0f131a; border-radius:20px; padding:20px; margin-bottom:24px;">
                    <div style="display:flex; gap:16px; align-items:center;">
                        <i class="fas fa-hand-pointer" style="font-size:2rem; color:#7aa2f7;"></i>
                        <div>
                            <div style="font-weight:600; margin-bottom:4px;">Cara terima file:</div>
                            <div style="color:#a0aec0; font-size:0.9rem;">1. Scan QR code di samping<br>2. Atau masukkan ID peer manual</div>
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap:12px; margin-bottom:20px;">
                    <input type="text" id="targetPeerId" placeholder="Masukkan ID peer" style="flex:1; background:#0a0d12; border:1px solid #4a5568; border-radius:40px; padding:12px 20px; color:white; outline:none;">
                    <button class="badge" onclick="connectToPeer()" style="background:#7aa2f7; color:white; padding:12px 24px; border-radius:40px; cursor:pointer;">
                        <i class="fas fa-plug"></i> Sambung
                    </button>
                </div>
                <div class="peer-status">
                    <span class="peer-dot" id="receiverPeerDot"></span>
                    <span id="receiverPeerStatus">Belum tersambung</span>
                </div>
                <div class="flex mt-2">
                    <button class="retry-btn" onclick="retryConnection()"><i class="fas fa-redo-alt"></i> Coba Sambung Ulang</button>
                    <button class="badge" onclick="resetReceiverPeer()" style="background:#555;"><i class="fas fa-power-off"></i> Reset</button>
                    <button class="badge" onclick="testConnection()" style="background:#2ed573; color:black;"><i class="fas fa-globe"></i> Test Koneksi</button>
                </div>
                <div class="incoming-area" style="margin-top:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
                        <span style="font-weight:600;"><i class="fas fa-download"></i> File Diterima</span>
                        <span class="badge" id="incomingCountBadge">0 file</span>
                    </div>
                    <div id="receiverFileListContainer"></div>
                    <button class="btn-outline" id="downloadAllBtn" disabled style="margin-top:20px;" onclick="downloadAllFiles()">
                        <i class="fas fa-file-export"></i> Download semua
                    </button>
                </div>
            </div>
        </div>
        <div class="logs-panel">
            <div class="logs-header"><i class="fas fa-shield-alt"></i> Peer-to-peer ‚Ä¢ WebRTC ‚Ä¢ TURN fallback</div>
            <div class="log-stream" id="logStream">
                <div class="log-entry"><span class="log-time">[System]</span> Inisialisasi...</div>
            </div>
        </div>
        <div class="footer-info">
            <div><i class="fas fa-check-circle" style="color:#7aa2f7;"></i> Koneksi via PeerJS + STUN + TURN</div>
            <div><i class="fas fa-qrcode"></i> QR = link koneksi langsung</div>
        </div>
    </div>

    <script>
        // ==================== KONFIGURASI ====================
        const PEER_SERVERS = {
            'peerjs.com': { host: 'peerjs.com', port: 443, secure: true },
            '0.peerjs.com': { host: '0.peerjs.com', port: 443, secure: true },
            'peerjs.xyz': { host: 'peerjs.xyz', port: 443, secure: true }
        };
        
        // ICE Servers dengan TURN fallback gratis dari metered.ca
        const ICE_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                { urls: 'stun:stun.services.mozilla.com' },
                // TURN fallback (gratis, rate limited)
                {
                    urls: 'turn:openrelay.metered.ca:80',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ]
        };

        // ==================== STATE ====================
        let peer = null;
        let conn = null;
        let isConnected = false;
        let selectedFiles = [];
        let receivedFiles = [];
        let currentPeerId = '';
        let currentServer = 'peerjs.com';

        // Receiver state
        let receiverPeer = null;
        let receiverConn = null;
        let retryCount = 0;
        const MAX_RETRY = 3;

        // DOM
        const peerDot = document.getElementById('peerDot');
        const peerStatus = document.getElementById('peerStatus');
        const receiverPeerDot = document.getElementById('receiverPeerDot');
        const receiverPeerStatus = document.getElementById('receiverPeerStatus');
        const peerIdInput = document.getElementById('peerIdInput');
        const qrImage = document.getElementById('qrImage');
        const dropZone = document.getElementById('dropZoneSender');
        const fileInput = document.getElementById('fileInputSender');
        const senderFileListContainer = document.getElementById('senderFileListContainer');
        const sendBtn = document.getElementById('sendBtn');
        const receiverFileListContainer = document.getElementById('receiverFileListContainer');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const incomingCountBadge = document.getElementById('incomingCountBadge');
        const logStream = document.getElementById('logStream');
        const targetPeerIdInput = document.getElementById('targetPeerId');
        const serverSelect = document.getElementById('serverSelect');

        // ==================== GENERATE ID UNIK ====================
        function generatePeerId() {
            return 'wf-' + Math.random().toString(36).substring(2, 10);
        }

        // ==================== SWITCH SERVER ====================
        window.switchServer = function() {
            currentServer = serverSelect.value;
            addLog(`üîÑ Ganti server ke: ${currentServer}`);
            if (peer) {
                peer.destroy();
                peer = null;
            }
            initPeer();
        };

        // ==================== INISIALISASI PEER (SENDER) ====================
        function initPeer() {
            const requestedId = generatePeerId();
            currentPeerId = requestedId;
            peerIdInput.value = requestedId;
            peerStatus.innerText = 'Membuat peer...';
            peerDot.classList.remove('connected');
            peerDot.classList.remove('warning');

            // Generate QR dari ID
            generateQRFromId(requestedId);
            addLog(`üîÑ Mencoba server ${currentServer} dengan ID: ${requestedId}`);

            const serverConfig = PEER_SERVERS[currentServer];
            if (!serverConfig) {
                addLog('‚ùå Server tidak dikenal');
                return;
            }

            peer = new Peer(requestedId, {
                host: serverConfig.host,
                port: serverConfig.port,
                secure: serverConfig.secure,
                config: ICE_SERVERS,
                debug: 2 // tampilkan log
            });

            peer.on('open', function(id) {
                currentPeerId = id;
                peerIdInput.value = id;
                peerStatus.innerText = 'Siap, ID: ' + id;
                peerDot.classList.add('connected');
                peerDot.classList.remove('warning');
                addLog('‚úÖ Peer siap. ID: ' + id + ' via ' + currentServer);
                if (id !== requestedId) {
                    generateQRFromId(id);
                }
            });

            peer.on('connection', function(connection) {
                conn = connection;
                isConnected = true;
                peerStatus.innerText = 'Terhubung dengan penerima';
                addLog('üîó Penerima terhubung!');

                conn.on('data', function(data) {
                    handleIncomingData(data);
                });

                conn.on('close', function() {
                    isConnected = false;
                    peerStatus.innerText = 'Koneksi terputus';
                    peerDot.classList.remove('connected');
                    addLog('‚ö†Ô∏è Koneksi dengan penerima putus');
                });

                conn.on('error', function(err) {
                    addLog('‚ùå Connection error: ' + err);
                });
            });

            peer.on('error', function(err) {
                console.error(err);
                addLog('‚ùå Peer error: ' + (err.type || err));
                
                if (err.type === 'unavailable-id') {
                    const newId = generatePeerId();
                    currentPeerId = newId;
                    peerIdInput.value = newId;
                    peerStatus.innerText = 'ID dipakai, ganti: ' + newId;
                    generateQRFromId(newId);
                    addLog('üîÑ ID sudah ada, ganti ke: ' + newId);
                    peer.reconnect();
                } else if (err.type === 'network' || err.message?.includes('network') || err.message?.includes('server')) {
                    peerStatus.innerText = '‚ö†Ô∏è Gagal konek ke server, coba lain...';
                    peerDot.classList.add('warning');
                    addLog('‚ö†Ô∏è Network error. Mencoba server alternatif...');
                    // Coba server lain
                    const servers = Object.keys(PEER_SERVERS);
                    const currentIdx = servers.indexOf(currentServer);
                    const nextIdx = (currentIdx + 1) % servers.length;
                    currentServer = servers[nextIdx];
                    serverSelect.value = currentServer;
                    addLog(`üîÑ Beralih ke server: ${currentServer}`);
                    setTimeout(() => {
                        peer.destroy();
                        peer = null;
                        initPeer();
                    }, 1500);
                }
            });
        }

        // ==================== GENERATE QR DARI ID ====================
        function generateQRFromId(id) {
            if (!id) return;
            const url = window.location.origin + window.location.pathname + '?connect=' + encodeURIComponent(id);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&margin=1&data=${encodeURIComponent(url)}&t=${Date.now()}`;
            qrImage.src = qrUrl;
            addLog('üì∏ QR code diperbarui: ' + id);
        }

        window.generateQR = function() {
            if (currentPeerId) generateQRFromId(currentPeerId);
        };

        // ==================== TEST KONEKSI INTERNET ====================
        window.testConnection = function() {
            addLog('üîÑ Testing koneksi ke PeerJS server...');
            fetch('https://' + currentServer + '/peerjs/id', { mode: 'no-cors' })
                .then(() => addLog('‚úÖ Server ' + currentServer + ' reachable'))
                .catch(() => addLog('‚ùå Server ' + currentServer + ' tidak dapat dijangkau'));
        };

        // ==================== RECEIVER SIDE ====================
        function checkUrlForAutoConnect() {
            const urlParams = new URLSearchParams(window.location.search);
            const targetId = urlParams.get('connect');
            if (targetId) {
                targetPeerIdInput.value = targetId;
                addLog('üîç Auto-connect ke: ' + targetId);
                setTimeout(() => connectToPeer(), 500);
            }
        }

        window.connectToPeer = function() {
            const targetId = targetPeerIdInput.value.trim();
            if (!targetId) { alert('Masukkan ID peer'); return; }

            receiverPeerStatus.innerText = 'Menghubungi ' + targetId + '...';
            receiverPeerDot.classList.remove('connected');
            receiverPeerDot.classList.remove('warning');

            if (receiverPeer) receiverPeer.destroy();
            receiverPeer = new Peer(generatePeerId(), {
                host: PEER_SERVERS[currentServer].host,
                port: PEER_SERVERS[currentServer].port,
                secure: PEER_SERVERS[currentServer].secure,
                config: ICE_SERVERS
            });

            receiverPeer.on('open', function(id) {
                addLog('üì± Receiver peer siap: ' + id + ' via ' + currentServer);
                const connection = receiverPeer.connect(targetId, {
                    reliable: true,
                    serialization: 'json',
                    metadata: { role: 'receiver' }
                });
                receiverConn = connection;

                connection.on('open', function() {
                    receiverPeerStatus.innerText = 'Terhubung ke ' + targetId;
                    receiverPeerDot.classList.add('connected');
                    addLog('‚úÖ Tersambung ke sender: ' + targetId);
                    retryCount = 0;
                });

                connection.on('data', function(data) {
                    handleIncomingData(data);
                });

                connection.on('close', function() {
                    receiverPeerStatus.innerText = 'Koneksi terputus';
                    receiverPeerDot.classList.remove('connected');
                    addLog('‚ö†Ô∏è Koneksi dengan sender putus');
                });

                connection.on('error', function(err) {
                    addLog('‚ùå Connection error: ' + err);
                    receiverPeerStatus.innerText = 'Gagal koneksi';
                    receiverPeerDot.classList.remove('connected');
                });
            });

            receiverPeer.on('error', function(err) {
                console.error('Receiver peer error:', err);
                receiverPeerStatus.innerText = 'Gagal koneksi ke server';
                addLog('‚ùå Receiver peer error: ' + (err.type || err));
                receiverPeerDot.classList.remove('connected');
                receiverPeerDot.classList.add('warning');
            });
        };

        window.retryConnection = function() {
            if (retryCount < MAX_RETRY) {
                retryCount++;
                addLog(`üîÑ Mencoba ulang (${retryCount}/${MAX_RETRY})...`);
                connectToPeer();
            } else {
                addLog('‚ùå Gagal setelah ' + MAX_RETRY + ' kali. Reset dan coba lagi.');
                alert('Gagal koneksi. Coba reset receiver atau ganti server.');
            }
        };

        window.resetReceiverPeer = function() {
            if (receiverPeer) receiverPeer.destroy();
            receiverPeer = null;
            receiverConn = null;
            retryCount = 0;
            receiverPeerStatus.innerText = 'Belum tersambung';
            receiverPeerDot.classList.remove('connected');
            receiverPeerDot.classList.remove('warning');
            addLog('üîÑ Receiver di-reset');
        };

        // ==================== HANDLE INCOMING FILE ====================
        function handleIncomingData(data) {
            if (data && data.type === 'file') {
                try {
                    const file = new File([data.buffer], data.name, { type: data.type });
                    receivedFiles.push({
                        file: file,
                        name: data.name,
                        size: data.size,
                        type: data.type
                    });
                    renderReceiverFileList();
                    addLog(`üì• Menerima: ${data.name} (${formatBytes(data.size)})`);
                } catch (e) {
                    addLog('‚ùå Error saat menerima file: ' + e);
                }
            }
        }

        // ==================== KIRIM FILE ====================
        window.sendFiles = function() {
            const activeConn = conn || receiverConn;
            if (!activeConn) {
                alert('Belum ada koneksi ke perangkat lain!');
                return;
            }
            if (selectedFiles.length === 0) {
                alert('Pilih file dulu!');
                return;
            }

            addLog(`üì§ Mengirim ${selectedFiles.length} file...`);

            selectedFiles.forEach((file) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = {
                        type: 'file',
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        buffer: e.target.result
                    };
                    activeConn.send(data);
                    addLog(`‚úÖ Terkirim: ${file.name}`);
                };
                reader.onerror = function(e) {
                    addLog(`‚ùå Gagal baca file: ${file.name}`);
                };
                reader.readAsArrayBuffer(file);
            });

            setTimeout(() => {
                selectedFiles = [];
                renderSenderFileList();
                addLog('üéâ Semua file terkirim!');
            }, 500);
        };

        // ==================== UPLOAD & FILE LIST ====================
        function handleSenderFiles(fileList) {
            if (!fileList || fileList.length === 0) return;
            const filesArray = Array.from(fileList);
            const newFiles = filesArray.filter(newFile => 
                !selectedFiles.some(ex => ex.name === newFile.name && ex.size === newFile.size)
            );
            if (newFiles.length === 0) return;
            selectedFiles = [...selectedFiles, ...newFiles];
            renderSenderFileList();
            addLog(`üìÅ +${newFiles.length} file (${formatBytes(newFiles.reduce((a,b)=>a+b.size,0))})`);
        }

        function renderSenderFileList() {
            if (selectedFiles.length === 0) {
                senderFileListContainer.innerHTML = `<div style="background:#0f131a; border-radius:16px; padding:24px; text-align:center; color:#718096;">
                    <i class="fas fa-folder-open" style="font-size:2rem; opacity:0.6;"></i>
                    <p style="margin-top:8px;">Belum ada file dipilih</p>
                </div>`;
                sendBtn.disabled = true;
                return;
            }
            sendBtn.disabled = false;
            let html = `<div class="file-list">`;
            selectedFiles.forEach((file, idx) => {
                html += `<div class="file-item">
                    <div class="file-info">
                        <span class="file-icon">${getFileIcon(file.type)}</span>
                        <div class="file-details">
                            <div class="file-name">${escapeHTML(file.name)}</div>
                            <div class="file-meta">${formatBytes(file.size)}</div>
                        </div>
                    </div>
                    <div><i class="fas fa-times" style="cursor:pointer; color:#f87171;" onclick="removeSenderFile(${idx})"></i></div>
                </div>`;
            });
            html += `</div>`;
            senderFileListContainer.innerHTML = html;
        }

        window.removeSenderFile = function(index) {
            selectedFiles.splice(index, 1);
            renderSenderFileList();
        };

        window.clearSenderFiles = function() {
            selectedFiles = [];
            renderSenderFileList();
        };

        // ==================== RECEIVER RENDER ====================
        function renderReceiverFileList() {
            if (receivedFiles.length === 0) {
                receiverFileListContainer.innerHTML = `<div class="empty-inbox">
                    <i class="fas fa-inbox"></i><p>Belum ada file diterima</p>
                </div>`;
                downloadAllBtn.disabled = true;
                incomingCountBadge.innerText = '0 file';
                return;
            }
            downloadAllBtn.disabled = false;
            incomingCountBadge.innerText = receivedFiles.length + ' file';
            let html = `<div class="file-list">`;
            receivedFiles.forEach((f, i) => {
                html += `<div class="file-item" style="border-left-color:#48bb78;">
                    <div class="file-info">
                        <span class="file-icon">${getFileIcon(f.type)}</span>
                        <div class="file-details">
                            <div class="file-name">${escapeHTML(f.name)}</div>
                            <div class="file-meta">${formatBytes(f.size)}</div>
                        </div>
                    </div>
                    <div><i class="fas fa-download" style="cursor:pointer; color:#7aa2f7;" onclick="downloadSingleFile(${i})"></i></div>
                </div>`;
            });
            html += `</div>`;
            receiverFileListContainer.innerHTML = html;
        }

        window.downloadSingleFile = function(index) {
            const file = receivedFiles[index].file;
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.downloadAllFiles = function() {
            receivedFiles.forEach((f, i) => setTimeout(() => downloadSingleFile(i), i * 200));
        };

        // ==================== UTILS ====================
        function getFileIcon(type) {
            if (type.includes('image')) return 'üñºÔ∏è';
            if (type.includes('video')) return 'üé¨';
            if (type.includes('audio')) return 'üéµ';
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('zip')||type.includes('rar')) return 'üì¶';
            if (type.includes('text')) return 'üìù';
            return 'üìÅ';
        }

        function formatBytes(b) {
            if (b===0) return '0 B';
            const u = ['B','KB','MB','GB'];
            const i = Math.floor(Math.log(b)/Math.log(1024));
            return (b/Math.pow(1024,i)).toFixed(1)+' '+u[i];
        }

        function escapeHTML(s) {
            return String(s).replace(/[&<>"]/g, function(c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];
            });
        }

        window.copyPeerId = function() {
            navigator.clipboard.writeText(currentPeerId);
            addLog('üìã ID peer dicopy');
        };

        function addLog(msg) {
            const e = document.createElement('div');
            e.className = 'log-entry';
            e.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'})}]</span> ${msg}`;
            logStream.appendChild(e);
            logStream.scrollTop = logStream.scrollHeight;
            if (logStream.children.length > 20) logStream.removeChild(logStream.children[0]);
        }

        // ==================== EVENT LISTENERS UPLOAD ====================
        function setupUploadListeners() {
            dropZone.addEventListener('click', (e) => { e.preventDefault(); fileInput.click(); });
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#7aa2f7'; dropZone.style.background = 'rgba(122,162,247,0.1)'; });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#4a5568'; dropZone.style.background = '#0f131a'; });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#4a5568'; dropZone.style.background = '#0f131a';
                if (e.dataTransfer.files.length) handleSenderFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handleSenderFiles(e.target.files);
                fileInput.value = '';
            });
        }

        // ==================== INIT ====================
        window.onload = function() {
            initPeer();
            setupUploadListeners();
            checkUrlForAutoConnect();
            renderSenderFileList();
            renderReceiverFileList();
            addLog('üí° Tips: Jika gagal, ganti server atau klik "Test Koneksi"');
        };
    </script>
</body>
</html>
