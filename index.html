<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üì¶ WebDrop ¬∑ QR Signaling (No PeerJS)</title>
    <!-- SimplePeer ‚Äì library WebRTC ringan, tanpa server signaling -->
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <!-- QRCode untuk generate & scan -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
    <style>
        /* ===== CSS SAMA PERSIS DENGAN ASLI (sedikit tambahan) ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #0b1120; color: white; display: flex; justify-content: center; padding: 20px; }
        .container { max-width: 750px; width: 100%; }
        .card { background: #1e293b; border-radius: 24px; padding: 24px; margin-bottom: 24px; border: 1px solid #334155; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); }
        h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .label { font-size: 0.85rem; color: #94a3b8; margin-bottom: 4px; }
        input, .code-box { width: 100%; padding: 14px 18px; background: #0f172a; border: 1px solid #334155; border-radius: 40px; color: white; font-size: 1rem; outline: none; transition: 0.2s; }
        input:focus { border-color: #3b82f6; background: #1e293b; }
        button { background: #3b82f6; color: white; border: none; padding: 14px 24px; border-radius: 40px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-top: 12px; }
        button:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59,130,246,0.4); }
        button.secondary { background: #334155; }
        button.secondary:hover { background: #475569; }
        .flex-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .code-box { display: flex; align-items: center; justify-content: space-between; background: #0f172a; padding: 8px 12px; }
        .code-box span { font-family: monospace; font-size: 1.2rem; color: #94a3b8; }
        .badge { background: #334155; border-radius: 30px; padding: 6px 14px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 6px; }
        .qr-container { background: white; border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 20px; margin-top: 16px; border: 2px solid #e2e8f0; }
        #qrImage { width: 100px; height: 100px; background: white; border-radius: 12px; object-fit: contain; }
        .device-list, .file-list, .received-list { margin-top: 12px; max-height: 250px; overflow-y: auto; border-radius: 16px; }
        .device-item, .file-item, .received-item { background: #263340; border-radius: 16px; padding: 14px 18px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #3b82f6; transition: 0.2s; }
        .device-item:hover { background: #334155; border-left-color: #60a5fa; }
        .device-item.selected { background: #1e3a5f; border-left-color: #fbbf24; }
        .file-info { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
        .file-icon { font-size: 1.8rem; }
        .file-details { flex: 1; min-width: 0; }
        .file-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 0.75rem; color: #94a3b8; }
        .progress-bar { width: 100%; height: 6px; background: #1e293b; border-radius: 6px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.2s; }
        .status-bar { background: #1a2634; border-radius: 40px; padding: 12px 20px; display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #f43f5e; }
        .dot.connected { background: #22c55e; box-shadow: 0 0 10px #22c55e; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
        .toast { position: fixed; top: 20px; right: 20px; background: #1e293b; border-left: 6px solid #3b82f6; border-radius: 16px; padding: 14px 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); max-width: 350px; z-index: 9999; display: none; }
        .toast.show { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .qr-scanner { background: #0f172a; border-radius: 16px; padding: 16px; margin-top: 16px; border: 2px solid #3b82f6; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; }
        hr { border: 1px solid #334155; margin: 20px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========== STATUS HEADER ========== -->
        <div class="status-bar">
            <span class="dot" id="connectionDot"></span>
            <span id="statusText">Inisialisasi...</span>
            <span style="margin-left: auto; display: flex; gap: 6px;">
                <span class="badge" id="roleBadge">-</span>
                <span class="badge" id="deviceCount">0 device</span>
            </span>
        </div>

        <!-- ========== KONEKSI VIA QR ========== -->
        <div class="card">
            <h3><span>üîó</span> Koneksi Peer‚Äëto‚ÄëPeer</h3>
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <button onclick="initiatorMode()" id="initiatorBtn" style="flex: 1;">üîµ Saya Host</button>
                <button onclick="receiverMode()" id="receiverBtn" style="flex: 1;" class="secondary">üü¢ Saya Member</button>
            </div>

            <!-- PANEL HOST: generate QR offer -->
            <div id="hostPanel" class="hidden">
                <div class="label">1. Host: generate kode QR</div>
                <button onclick="createOffer()" id="createOfferBtn">üé´ Buat QR Koneksi</button>
                <div id="hostQRContainer" class="qr-container" style="display: none;">
                    <img id="hostQRImage" src="" alt="QR Offer">
                    <div style="flex:1;">
                        <div style="font-weight: 600; color:#0b0e14;">üî≥ Scan QR ini dari HP</div>
                        <div style="font-size:0.85rem; color:#2d3a4a;">Member scan, lalu akan muncul QR balasan</div>
                    </div>
                </div>
            </div>

            <!-- PANEL MEMBER: scan offer, generate answer -->
            <div id="memberPanel" class="hidden">
                <div class="label">1. Member: scan QR dari Host</div>
                <div id="reader" style="width: 100%;"></div>
                <div id="answerQRContainer" class="qr-container" style="display: none; margin-top: 16px;">
                    <img id="answerQRImage" src="" alt="QR Answer">
                    <div style="flex:1;">
                        <div style="font-weight: 600; color:#0b0e14;">üî≥ Scan QR ini dengan Host</div>
                        <div style="font-size:0.85rem; color:#2d3a4a;">Host scan untuk menyelesaikan koneksi</div>
                    </div>
                </div>
            </div>

            <!-- PANEL HOST: scan answer -->
            <div id="hostAnswerPanel" class="hidden">
                <div class="label">2. Host: scan QR balasan dari Member</div>
                <div id="hostReader" style="width: 100%;"></div>
            </div>

            <div style="margin-top: 16px;">
                <div class="label">ID Peer Kamu (random)</div>
                <div class="code-box">
                    <span id="myPeerId">-</span>
                    <button class="badge" onclick="copyMyId()" style="background: #475569;">Copy</button>
                </div>
            </div>
        </div>

        <!-- ========== DEVICE DI ROOM ========== -->
        <div class="card">
            <h3><span>üì±</span> Device di Room</h3>
            <div id="deviceListContainer" class="device-list">
                <div style="color: #94a3b8; padding: 20px; text-align: center;">Belum ada device lain</div>
            </div>
        </div>

        <!-- ========== FILE YANG AKAN DIKIRIM ========== -->
        <div class="card">
            <h3><span>üì§</span> Kirim File</h3>
            <div style="display: flex; gap: 12px;">
                <button onclick="pickFile()" id="pickFileBtn" disabled style="flex: 2;">
                    <i class="fas fa-file"></i> Pilih File
                </button>
                <button onclick="clearSelectedFiles()" class="secondary" style="flex: 1;">
                    <i class="fas fa-trash"></i> Hapus
                </button>
            </div>
            <input type="file" id="fileInput" multiple style="display: none;">
            <div id="selectedFileList" class="file-list" style="margin-top: 20px;"></div>
            <div style="margin-top: 16px;">
                <div class="label">Device tujuan</div>
                <select id="targetDeviceSelect" style="width:100%; padding:14px; background:#0f172a; border:1px solid #334155; border-radius:40px; color:white;">
                    <option value="">-- Pilih device target --</option>
                </select>
            </div>
            <button onclick="sendFiles()" id="sendBtn" disabled style="margin-top: 20px;">
                <i class="fas fa-paper-plane"></i> Kirim Sekarang
            </button>
            <div class="progress-bar" style="margin-top: 16px;">
                <div class="progress-fill" id="globalProgress"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 6px;">
                <span id="progressText">-</span>
                <span id="selectedSize">0 KB</span>
            </div>
        </div>

        <!-- ========== FILE DITERIMA ========== -->
        <div class="card">
            <h3><span>üì•</span> File Diterima</h3>
            <div id="receivedListContainer" class="received-list">
                <div style="color: #94a3b8; padding: 20px; text-align: center;">Belum ada file diterima</div>
            </div>
        </div>

        <!-- ========== TOAST NOTIFIKASI ========== -->
        <div id="toast" class="toast"></div>
    </div>

    <script>
        // ==================================================
        //   KONFIGURASI ICE (STUN/TURN) ‚Äì SAMA SEPERTI SEBELUMNYA
        // ==================================================
        const ICE_CONFIG = {
            iceServers: [
                { urls: 'stun:stun.cloudflare.com:3478' },
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
                { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        };

        // ========== STATE ==========
        let peer;                 // SimplePeer instance (hanya untuk 1 koneksi)
        let myId = generatePeerId();
        let isInitiator = false;  // true = host, false = member
        let connections = {};     // peerId -> { peer: SimplePeer, dc: DataChannel }
        let currentTarget = null;
        let selectedFiles = [];
        let receivedFiles = [];

        // DOM
        const connectionDot = document.getElementById('connectionDot');
        const statusText = document.getElementById('statusText');
        const roleBadge = document.getElementById('roleBadge');
        const deviceCountSpan = document.getElementById('deviceCount');
        const myPeerIdSpan = document.getElementById('myPeerId');
        const deviceListContainer = document.getElementById('deviceListContainer');
        const targetDeviceSelect = document.getElementById('targetDeviceSelect');
        const pickFileBtn = document.getElementById('pickFileBtn');
        const sendBtn = document.getElementById('sendBtn');
        const fileInput = document.getElementById('fileInput');
        const selectedFileListDiv = document.getElementById('selectedFileList');
        const receivedListContainer = document.getElementById('receivedListContainer');
        const globalProgress = document.getElementById('globalProgress');
        const progressText = document.getElementById('progressText');
        const selectedSizeSpan = document.getElementById('selectedSize');
        const toast = document.getElementById('toast');

        // QR elements
        const hostPanel = document.getElementById('hostPanel');
        const memberPanel = document.getElementById('memberPanel');
        const hostAnswerPanel = document.getElementById('hostAnswerPanel');
        const hostQRContainer = document.getElementById('hostQRContainer');
        const hostQRImage = document.getElementById('hostQRImage');
        const answerQRContainer = document.getElementById('answerQRContainer');
        const answerQRImage = document.getElementById('answerQRImage');
        let html5Qrcode = null;
        let hostHtml5Qrcode = null;

        // ========== INIT ==========
        window.onload = function() {
            myPeerIdSpan.innerText = myId;
            showToast('üü¢ Pilih peran: Host (buat QR) atau Member (scan QR).', 'info');
            statusText.innerText = 'Pilih peran';
            connectionDot.classList.remove('connected');
        };

        function generatePeerId() {
            return 'device-' + Math.random().toString(36).substring(2, 10);
        }

        // ========== MODE HOST ==========
        window.initiatorMode = function() {
            isInitiator = true;
            roleBadge.innerText = 'HOST';
            statusText.innerText = 'Mode Host';
            connectionDot.classList.remove('connected');
            hostPanel.classList.remove('hidden');
            memberPanel.classList.add('hidden');
            hostAnswerPanel.classList.add('hidden');
            showToast('üëë Host: klik "Buat QR Koneksi"', 'info');
        };

        // ========== MODE MEMBER ==========
        window.receiverMode = function() {
            isInitiator = false;
            roleBadge.innerText = 'MEMBER';
            statusText.innerText = 'Mode Member';
            connectionDot.classList.remove('connected');
            hostPanel.classList.add('hidden');
            memberPanel.classList.remove('hidden');
            hostAnswerPanel.classList.add('hidden');
            startQRScanner();
        };

        // ========== HOST: BUAT OFFER ==========
        window.createOffer = function() {
            // Inisialisasi SimplePeer sebagai initiator
            peer = new SimplePeer({
                initiator: true,
                trickle: false,
                config: ICE_CONFIG
            });

            peer.on('signal', (data) => {
                // Ketika signal (offer) siap, encode jadi QR
                const offerStr = JSON.stringify(data);
                QRCode.toCanvas(hostQRImage, offerStr, { width: 200 }, (err) => {
                    if (err) {
                        showToast('‚ùå Gagal generate QR', 'error');
                        return;
                    }
                    hostQRContainer.style.display = 'flex';
                    showToast('‚úÖ QR siap! Member scan QR ini.', 'success');
                });
            });

            peer.on('connect', () => {
                connectionDot.classList.add('connected');
                statusText.innerText = 'Host terhubung dengan Member';
                // Set up data channel
                peer.send(JSON.stringify({ type: 'peerId', id: myId }));
                setupPeerEvents(peer, 'member-1');
                // Hentikan scanner di host
                if (hostHtml5Qrcode) {
                    hostHtml5Qrcode.stop();
                    hostHtml5Qrcode = null;
                }
                hostAnswerPanel.classList.add('hidden');
                showToast('üîó Koneksi terestabilisasi!', 'success');
            });

            peer.on('error', (err) => {
                console.error(err);
                showToast(`‚ùå Peer error: ${err}`, 'error');
            });
        };

        // ========== MEMBER: SCAN QR OFFER ==========
        function startQRScanner() {
            html5Qrcode = new Html5Qrcode("reader");
            html5Qrcode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    // QR terbaca = offer dari host
                    html5Qrcode.stop();
                    html5Qrcode = null;
                    showToast('‚úÖ QR offer terbaca, membuat answer...', 'success');

                    // Parse offer
                    const offer = JSON.parse(decodedText);
                    
                    // Inisialisasi SimplePeer sebagai receiver
                    peer = new SimplePeer({
                        initiator: false,
                        trickle: false,
                        config: ICE_CONFIG
                    });

                    peer.on('signal', (data) => {
                        // answer siap, encode jadi QR
                        const answerStr = JSON.stringify(data);
                        QRCode.toCanvas(answerQRImage, answerStr, { width: 200 }, (err) => {
                            answerQRContainer.style.display = 'flex';
                            showToast('‚úÖ QR answer siap! Host scan QR ini.', 'success');
                        });
                    });

                    peer.on('connect', () => {
                        connectionDot.classList.add('connected');
                        statusText.innerText = 'Member terhubung dengan Host';
                        peer.send(JSON.stringify({ type: 'peerId', id: myId }));
                        setupPeerEvents(peer, 'host');
                        showToast('üîó Koneksi terestabilisasi!', 'success');
                    });

                    peer.on('error', (err) => {
                        showToast(`‚ùå Peer error: ${err}`, 'error');
                    });

                    // Set remote offer
                    peer.signal(offer);
                },
                (error) => { /* ignore */ }
            );
        }

        // ========== HOST: SCAN QR ANSWER ==========
        function startHostScanner() {
            hostHtml5Qrcode = new Html5Qrcode("hostReader");
            hostHtml5Qrcode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    hostHtml5Qrcode.stop();
                    hostHtml5Qrcode = null;
                    showToast('‚úÖ QR answer terbaca, koneksi final...', 'success');
                    const answer = JSON.parse(decodedText);
                    if (peer) {
                        peer.signal(answer);
                    }
                },
                (error) => { /* ignore */ }
            );
        }

        // ========== SETUP EVENTS UNTUK PEER ==========
        function setupPeerEvents(peerInstance, peerId) {
            // Simpan koneksi
            connections[peerId] = { peer: peerInstance, dc: null };
            updateDeviceList();

            let fileBuffer = [];
            let fileMeta = null;
            let fileProgress = 0;

            peerInstance.on('data', (data) => {
                // Data dari SimplePeer bisa string atau Buffer (ArrayBuffer)
                if (typeof data === 'string') {
                    try {
                        const msg = JSON.parse(data);
                        if (msg.type === 'peerId') {
                            // Daftarkan dengan ID asli
                            delete connections[peerId];
                            connections[msg.id] = { peer: peerInstance, dc: null };
                            updateDeviceList();
                        } else if (msg.type === 'file-meta') {
                            fileMeta = msg;
                            fileBuffer = [];
                            fileProgress = 0;
                            showToast(`üì• Menerima: ${msg.name}`, 'info');
                        } else if (msg.type === 'file-end') {
                            if (fileMeta) {
                                const blob = new Blob(fileBuffer, { type: fileMeta.mime });
                                const file = new File([blob], fileMeta.name, { type: fileMeta.mime });
                                receivedFiles.push({ file, name: fileMeta.name, size: fileMeta.size, type: fileMeta.mime });
                                renderReceivedFiles();
                                showToast(`‚úÖ Selesai menerima: ${fileMeta.name}`, 'success');
                            }
                            fileMeta = null;
                            fileBuffer = [];
                        }
                    } catch (e) {}
                } else {
                    // data adalah buffer (Uint8Array / ArrayBuffer)
                    if (fileMeta) {
                        fileBuffer.push(data);
                        fileProgress += data.byteLength || data.length;
                        // update progress global (optional)
                    }
                }
            });
        }

        // ========== UPDATE UI DEVICE ==========
        function updateDeviceList() {
            const deviceList = Object.keys(connections);
            deviceCountSpan.innerText = deviceList.length + ' device';

            let html = '';
            if (deviceList.length === 0) {
                html = '<div style="color: #94a3b8; padding: 20px; text-align: center;">Belum ada device lain</div>';
            } else {
                deviceList.forEach(id => {
                    const isSelected = (currentTarget === id);
                    html += `<div class="device-item ${isSelected ? 'selected' : ''}" onclick="selectTarget('${id}')">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <span style="font-size:1.4rem;">üì±</span>
                                    <span style="font-family:monospace;">${id.substring(0,8)}...</span>
                                </div>
                                <span class="badge" style="background:${isSelected ? '#fbbf24' : '#334155'}; color:black;">${isSelected ? '‚úì' : 'Pilih'}</span>
                            </div>`;
                });
            }
            deviceListContainer.innerHTML = html;

            let options = '<option value="">-- Pilih device target --</option>';
            deviceList.forEach(id => {
                options += `<option value="${id}" ${currentTarget === id ? 'selected' : ''}>${id.substring(0,8)}...</option>`;
            });
            targetDeviceSelect.innerHTML = options;

            pickFileBtn.disabled = !currentTarget;
            sendBtn.disabled = !currentTarget || selectedFiles.length === 0;
        }

        window.selectTarget = function(id) {
            currentTarget = id;
            updateDeviceList();
            showToast(`üéØ Target: ${id.substring(0,8)}...`, 'info');
        };
        targetDeviceSelect.addEventListener('change', (e) => {
            currentTarget = e.target.value;
            updateDeviceList();
        });

        // ========== COPY ID ==========
        window.copyMyId = function() {
            navigator.clipboard.writeText(myId);
            showToast('üìã ID peer dicopy', 'success');
        };

        // ========== FILE HANDLING (SAMA PERSIS) ==========
        window.pickFile = function() {
            if (!currentTarget) { showToast('‚ùå Pilih device target dulu!', 'error'); return; }
            fileInput.click();
        };
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const newFiles = Array.from(e.target.files).filter(f => 
                    !selectedFiles.some(ex => ex.name === f.name && ex.size === f.size)
                );
                selectedFiles = [...selectedFiles, ...newFiles];
                renderSelectedFiles();
                e.target.value = '';
            }
        });

        function renderSelectedFiles() {
            if (selectedFiles.length === 0) {
                selectedFileListDiv.innerHTML = '<div style="color:#94a3b8; padding:20px; text-align:center;">Belum ada file dipilih</div>';
                selectedSizeSpan.innerText = '0 KB';
                sendBtn.disabled = true;
                return;
            }
            let totalSize = 0;
            let html = '';
            selectedFiles.forEach((f, i) => {
                totalSize += f.size;
                const icon = getFileIcon(f.type);
                html += `<div class="file-item">
                            <div class="file-info">
                                <span class="file-icon">${icon}</span>
                                <div class="file-details">
                                    <div class="file-name">${escapeHTML(f.name)}</div>
                                    <div class="file-meta">${formatBytes(f.size)}</div>
                                </div>
                            </div>
                            <i class="fas fa-times" style="color:#f87171; cursor:pointer; padding:8px;" onclick="removeFile(${i})"></i>
                        </div>`;
            });
            selectedFileListDiv.innerHTML = html;
            selectedSizeSpan.innerText = formatBytes(totalSize);
            sendBtn.disabled = !currentTarget;
        }

        window.removeFile = function(index) { selectedFiles.splice(index, 1); renderSelectedFiles(); };
        window.clearSelectedFiles = function() { selectedFiles = []; renderSelectedFiles(); };

        // ========== KIRIM FILE ==========
        window.sendFiles = async function() {
            if (!currentTarget) { showToast('‚ùå Pilih target!', 'error'); return; }
            if (selectedFiles.length === 0) { showToast('‚ùå Tidak ada file!', 'error'); return; }

            const conn = connections[currentTarget]?.peer;
            if (!conn) { showToast('‚ùå Koneksi ke target tidak tersedia', 'error'); return; }

            let totalSent = 0;
            const totalSize = selectedFiles.reduce((a,b)=>a+b.size,0);
            showToast(`üì§ Mengirim ${selectedFiles.length} file...`, 'info');

            for (const file of selectedFiles) {
                await sendOneFile(conn, file, totalSent, totalSize);
                totalSent += file.size;
            }
            showToast('‚úÖ Semua file terkirim!', 'success');
        };

        function sendOneFile(conn, file, sentBefore, totalSize) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const buffer = e.target.result;
                    const CHUNK = 256 * 1024; // 256KB

                    conn.send(JSON.stringify({ 
                        type: 'file-meta', 
                        name: file.name, 
                        size: file.size, 
                        mime: file.type 
                    }));

                    let offset = 0;
                    const chunkInterval = setInterval(() => {
                        if (offset >= buffer.byteLength) {
                            clearInterval(chunkInterval);
                            conn.send(JSON.stringify({ type: 'file-end' }));
                            resolve();
                            return;
                        }
                        const chunk = buffer.slice(offset, offset + CHUNK);
                        // SimplePeer bisa kirim Buffer langsung
                        conn.send(chunk);
                        offset += chunk.byteLength;

                        const percent = ((sentBefore + offset) / totalSize) * 100;
                        globalProgress.style.width = percent + '%';
                        progressText.innerText = Math.round(percent) + '%';
                    }, 30);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // ========== RENDER FILE DITERIMA ==========
        function renderReceivedFiles() {
            if (receivedFiles.length === 0) {
                receivedListContainer.innerHTML = '<div style="color:#94a3b8; padding:20px; text-align:center;">Belum ada file diterima</div>';
                return;
            }
            let html = '';
            receivedFiles.forEach((f, i) => {
                const icon = getFileIcon(f.type);
                html += `<div class="file-item" style="border-left-color:#22c55e;">
                            <div class="file-info">
                                <span class="file-icon">${icon}</span>
                                <div class="file-details">
                                    <div class="file-name">${escapeHTML(f.name)}</div>
                                    <div class="file-meta">${formatBytes(f.size)}</div>
                                </div>
                            </div>
                            <i class="fas fa-download" style="color:#3b82f6; cursor:pointer; padding:8px;" onclick="downloadReceived(${i})"></i>
                        </div>`;
            });
            receivedListContainer.innerHTML = html;
        }

        window.downloadReceived = function(index) {
            const f = receivedFiles[index];
            const url = URL.createObjectURL(f.file);
            const a = document.createElement('a');
            a.href = url;
            a.download = f.name;
            a.click();
            URL.revokeObjectURL(url);
        };

        // ========== UTILS ==========
        function getFileIcon(type) {
            if (type.includes('image')) return 'üñºÔ∏è';
            if (type.includes('video')) return 'üé¨';
            if (type.includes('audio')) return 'üéµ';
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('zip')||type.includes('rar')) return 'üì¶';
            if (type.includes('text')) return 'üìù';
            return 'üìÅ';
        }
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
        }
        function escapeHTML(s) {
            return String(s).replace(/[&<>"]/g, c => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' })[c]);
        }
        function showToast(msg, type = 'info') {
            toast.innerHTML = msg;
            toast.style.borderLeftColor = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // ========== TOMBOL KHUSUS HOST SCAN ANSWER ==========
        // Override: setelah member generate answer, host harus scan
        // Kita panggil startHostScanner() dari host
        // Perbaiki alur: setelah host buat QR offer, dia juga harus siap scan answer.
        // Sederhananya: host klik "Buat QR", lalu otomatis tampilkan scanner answer.
        // Mari kita modifikasi sedikit:
        window.createOffer = function() {
            // ... sama seperti sebelumnya
            peer = new SimplePeer({ initiator: true, trickle: false, config: ICE_CONFIG });
            peer.on('signal', (data) => {
                const offerStr = JSON.stringify(data);
                QRCode.toCanvas(hostQRImage, offerStr, { width: 200 }, (err) => {
                    if (err) { showToast('‚ùå Gagal generate QR', 'error'); return; }
                    hostQRContainer.style.display = 'flex';
                    showToast('‚úÖ QR siap! Setelah member scan, dia akan generate QR balasan. Scan QR itu di sini.', 'info');
                    // Tampilkan panel scanner untuk answer
                    hostAnswerPanel.classList.remove('hidden');
                    startHostScanner();
                });
            });
            peer.on('connect', () => {
                connectionDot.classList.add('connected');
                statusText.innerText = 'Host terhubung dengan Member';
                peer.send(JSON.stringify({ type: 'peerId', id: myId }));
                setupPeerEvents(peer, 'member-1');
                if (hostHtml5Qrcode) { hostHtml5Qrcode.stop(); hostHtml5Qrcode = null; }
                hostAnswerPanel.classList.add('hidden');
                showToast('üîó Koneksi terestabilisasi!', 'success');
            });
            peer.on('error', (err) => { showToast(`‚ùå Peer error: ${err}`, 'error'); });
        };

        // FontAwesome
        const faLink = document.createElement('link');
        faLink.rel = 'stylesheet';
        faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css';
        document.head.appendChild(faLink);
    </script>
</body>
</html>
