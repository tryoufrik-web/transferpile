<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebDrop Room</title>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body{
margin:0;
background:#0f172a;
font-family:Arial;
color:white;
display:flex;
justify-content:center;
}
.container{
max-width:700px;
width:100%;
padding:20px;
}
.card{
background:#1e293b;
padding:20px;
border-radius:16px;
margin-bottom:20px;
}
input,button{
width:100%;
padding:12px;
border-radius:10px;
border:none;
margin-top:8px;
}
button{
background:#3b82f6;
color:white;
cursor:pointer;
}
.device{
background:#334155;
padding:10px;
border-radius:10px;
margin-top:6px;
cursor:pointer;
}
.progress{
background:#334155;
height:8px;
border-radius:10px;
overflow:hidden;
margin-top:10px;
}
.bar{
height:100%;
width:0%;
background:#22c55e;
}
.file{
background:#475569;
padding:10px;
border-radius:10px;
margin-top:6px;
}
</style>
</head>

<body>
<div class="container">

<div class="card">
<h3>Room Code</h3>
<input id="roomInput" placeholder="Masukkan kode room">
<button onclick="joinRoom()">Join Room</button>
<div id="myId"></div>
</div>

<div class="card">
<h3>Device di Room</h3>
<div id="deviceList"></div>
</div>

<div class="card">
<h3>Kirim File</h3>
<input type="file" id="fileInput" hidden multiple>
<button onclick="pickFile()">Pilih File</button>
<div class="progress"><div class="bar" id="progressBar"></div></div>
</div>

<div class="card">
<h3>Diterima</h3>
<div id="receivedList"></div>
</div>

</div>

<script>
let peer;
let myId;
let roomHostId;
let connections = {};
let selectedTarget = null;
const CHUNK = 256*1024;

function joinRoom(){
const room = document.getElementById("roomInput").value.trim();
if(!room) return alert("Masukkan kode room!");

peer = new Peer(undefined,{
config:{iceServers:[{urls:'stun:stun.l.google.com:19302'}]}
});

peer.on("open",id=>{
myId=id;
document.getElementById("myId").innerText="ID: "+id;

roomHostId="room-"+room;

const hostConn = peer.connect(roomHostId);
hostConn.on("error",()=>{
// Kalau gagal berarti belum ada host â†’ jadi host
peer.destroy();
peer=new Peer(roomHostId);
peer.on("open",()=>{
roomHostId=peer.id;
});
peer.on("connection",setupConnection);
});
hostConn.on("open",()=>{
hostConn.send({type:"join",id:myId});
});
hostConn.on("data",data=>{
if(data.type==="list"){
data.ids.forEach(connectToPeer);
}
});
});

peer.on("connection",setupConnection);
}

function connectToPeer(id){
if(id===myId || connections[id]) return;
const conn=peer.connect(id);
setupConnection(conn);
}

function setupConnection(conn){
connections[conn.peer]=conn;
renderDevices();

let buffer=[];
let meta=null;

conn.on("data",data=>{
if(data.type==="join" && peer.id===roomHostId){
connections[data.id]=null;
broadcastList();
}
else if(data.type==="list"){
data.ids.forEach(connectToPeer);
}
else if(data.type==="meta"){
meta=data;
buffer=[];
}
else if(data instanceof ArrayBuffer){
buffer.push(data);
}
else if(data.type==="end"){
const blob=new Blob(buffer,{type:meta.mime});
downloadBlob(blob,meta.name);
}
});
}

function broadcastList(){
const ids=Object.keys(connections);
Object.values(connections).forEach(c=>{
if(c && c.open){
c.send({type:"list",ids:ids});
}
});
}

function renderDevices(){
const div=document.getElementById("deviceList");
div.innerHTML="";
Object.keys(connections).forEach(id=>{
if(id===myId) return;
div.innerHTML+=`<div class="device" onclick="selectDevice('${id}')">${id}</div>`;
});
}

function selectDevice(id){
selectedTarget=id;
alert("Target dipilih: "+id);
}

function pickFile(){
if(!selectedTarget) return alert("Pilih device dulu!");
document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change",e=>{
sendFiles([...e.target.files]);
});

async function sendFiles(files){
const conn=connections[selectedTarget];
if(!conn||!conn.open) return alert("Device tidak terkoneksi!");

let total=files.reduce((a,b)=>a+b.size,0);
let sent=0;

for(const file of files){
await sendOne(conn,file,total,sent);
sent+=file.size;
}
alert("Selesai kirim!");
}

function sendOne(conn,file,total,sent){
return new Promise(resolve=>{
const reader=new FileReader();
reader.onload=e=>{
const buffer=e.target.result;

conn.send({type:"meta",name:file.name,mime:file.type});

let offset=0;

while(offset<buffer.byteLength){
const chunk=buffer.slice(offset,offset+CHUNK);
conn.send(chunk);
offset+=CHUNK;

let percent=((sent+offset)/total)*100;
document.getElementById("progressBar").style.width=percent+"%";
}

conn.send({type:"end"});
resolve();
};
reader.readAsArrayBuffer(file);
});
}

function downloadBlob(blob,name){
const url=URL.createObjectURL(blob);
const a=document.createElement("a");
a.href=url;
a.download=name;
a.click();
}

</script>
</body>
</html>
